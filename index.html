<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Alert System</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00aaff;
            --primary-dark: #0088cc;
            --alert-color: #ff4757;
            --stop-color: #ff6347;
            --light-bg: #f0f8ff;
            --dark-text: #333;
            --light-text: #777;
            --border-color: #d6e9f8;
            --shadow: 0 6px 20px rgba(0, 170, 255, 0.15);
        }
        
        /* ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡¶¨ CSS ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ */
        body, .container, #settings, #settings legend,
        #settings div, #settings label, #settings:disabled,
        .controls, #cartoonVisualizer, #cartoonVisualizer.alert,
        @keyframes shake, .sound-level-meter, #soundLevelBar,
        .button, .button:active, #toggleButton, #toggleButton:hover,
        #toggleButton.stop-mode, #logContainer,
        #logContainer h3, #logList, #logList li, @keyframes slideIn {
             /* ... ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ... */
        }

        /* ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶è‡¶¨‡¶Ç ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        #settings input, #settings select {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fcfcfc;
        }
        #settings input:focus, #settings select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.15);
        }

        /* ‡¶®‡¶§‡ßÅ‡¶®: ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá */
        #countDisplay {
            font-size: 1rem;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 10px;
            padding: 5px 10px;
            background: #e0f7fa;
            border-radius: 5px;
            display: inline-block;
        }
        /* ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶≤‡¶æ‡¶≤ ‡¶π‡¶¨‡ßá */
        #countDisplay.limit-reached {
            color: white;
            background: var(--stop-color);
        }

        #status {
            font-size: 1.05rem;
            margin-top: 20px;
            color: var(--light-text);
            min-height: 1.2em;
        }
        
        /* ‡¶¨‡¶æ‡¶ï‡¶ø CSS */
        body { font-family: 'Roboto', sans-serif; background: var(--light-bg); color: var(--dark-text); display: grid; place-items: center; min-height: 100vh; padding: 20px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .container { width: 100%; max-width: 480px; background: #ffffff; border-radius: 20px; box-shadow: var(--shadow); overflow: hidden; border: 2px solid #fff; }
        #settings { padding: 25px; border: none; background-color: #fff; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s ease; }
        #settings legend { font-size: 1.6rem; font-weight: 700; color: var(--primary-color); margin-bottom: 25px; text-align: center; width: 100%; }
        #settings div { margin-bottom: 18px; }
        #settings label { font-weight: 500; display: block; margin-bottom: 8px; color: var(--light-text); font-size: 0.95rem; }
        #settings:disabled { opacity: 0.5; pointer-events: none; }
        .controls { padding: 25px; text-align: center; position: relative; }
        #cartoonVisualizer { font-size: 5rem; margin-bottom: 15px; transition: transform 0.1s ease-out, color 0.3s; cursor: default; position: relative; z-index: 1; }
        #cartoonVisualizer.alert { color: var(--alert-color); animation: shake 0.4s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .sound-level-meter { width: 80%; height: 30px; background-color: var(--light-bg); border: 2px solid var(--border-color); border-radius: 15px; margin: 0 auto 20px auto; overflow: hidden; }
        #soundLevelBar { width: 0%; height: 100%; background-color: hsl(120, 100%, 50%); border-radius: 15px; transition: width 0.1s ease-out, background-color 0.1s ease-out; }
        .button { width: 100%; font-size: 1.2rem; font-weight: 700; padding: 16px 30px; cursor: pointer; color: white; border: none; border-radius: 10px; transition: background-color 0.3s, transform 0.1s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; z-index: 2; }
        .button:active { transform: scale(0.97); }
        #toggleButton { background: var(--primary-color); }
        #toggleButton:hover { background: var(--primary-dark); }
        #toggleButton.stop-mode { background: var(--stop-color); }
        #toggleButton.stop-mode:hover { background: var(--alert-color); }
        #logContainer { background: var(--light-bg); padding: 20px 25px; border-top: 1px solid var(--border-color); }
        #logContainer h3 { font-weight: 500; margin-bottom: 15px; text-align: center; color: var(--dark-text); font-size: 1.3rem; }
        #logList { list-style: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); background: #fff; border-radius: 10px; padding: 10px; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.03); }
        #logList li { padding: 10px 12px; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: var(--dark-text); border-bottom: 1px solid #eee; animation: slideIn 0.3s ease-out; }
        #logList li:last-child { border-bottom: none; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

    </style>
</head>
<body>

    <div class="container">
        <fieldset id="settings">
            <legend>Sound Alert Settings</legend>
            
            <div>
                <label for="fileNameSelect">Select MP3 File:</label>
                <select id="fileNameSelect">
                    <option value="ringtone.mp3">Ringtone</option>
                    <option value="Scary Music.mp3">Scary Music</option>
                    <option value="donkey.mp3">donkey</option>
                    <option value="alhamdulillah.mp3">alhamdulillah</option>
                </select>
            </div>
            
            <div>
                <label for="thresholdInput">Threshold Limit (0-255):</label>
                <input type="number" id="thresholdInput" value="50">
            </div>

            <div>
                <label for="maxAlertsInput">Max Alerts Limit:</label>
                <input type="number" id="maxAlertsInput" value="5" min="1">
            </div>

            <div>
                <label for="intervalInput">Log Interval (Seconds):</label>
                <input type="number" id="intervalInput" value="2">
            </div>
        </fieldset>

        <div class="controls">
            <div id="countDisplay">Alerts: 0 / 5</div>

            <div id="cartoonVisualizer">üéß</div>
            <div class="sound-level-meter">
                <div id="soundLevelBar"></div>
            </div>
            <button id="toggleButton" class="button">Start Listening</button>
            <div id="status">Click 'Start Listening' to begin.</div>
        </div>

        <audio id="ringtone" preload="auto"></audio>

        <div id="logContainer">
            <h3>Sound Level Log</h3>
            <ul id="logList"></ul>
        </div>
        
    </div>

    <script>
        const toggleButton = document.getElementById('toggleButton');
        const statusDiv = document.getElementById('status');
        const ringtone = document.getElementById('ringtone');
        const logList = document.getElementById('logList');
        const visualizer = document.getElementById('cartoonVisualizer');
        const soundLevelBar = document.getElementById('soundLevelBar');
        const settingsContainer = document.getElementById('settings');
        
        // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá
        const countDisplay = document.getElementById('countDisplay');

        const fileNameSelect = document.getElementById('fileNameSelect'); 
        const thresholdInput = document.getElementById('thresholdInput');
        const intervalInput = document.getElementById('intervalInput');
        // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
        const maxAlertsInput = document.getElementById('maxAlertsInput');

        let SOUND_THRESHOLD;
        let LOG_INTERVAL_MS;
        let MAX_ALERTS; // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤
        const COOLDOWN_SECONDS = 5; 
        let barMaxValue; 

        let isPlaying = false;
        let lastPlayedTime = 0;
        let averageVolume = 0;
        let isListening = false; 
        
        let alertCount = 0; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶ó‡ßã‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        
        let stream, audioContext, analyser, dataArray, logInterval;
        let wakeLock = null;

        function checkSoundLevel() {
            if (!isListening) return; 
            
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            averageVolume = sum / dataArray.length;
            
            // ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            let statusText = `Current Level: ${averageVolume.toFixed(2)} (Threshold: ${SOUND_THRESHOLD})`;

            // ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
            if (alertCount >= MAX_ALERTS) {
                statusText = "Max alerts reached! Reset required.";
                statusDiv.style.color = "var(--stop-color)";
            } else {
                statusDiv.style.color = "var(--light-text)";
            }
            statusDiv.textContent = statusText;
            
            let soundPercentage = Math.min(100, (averageVolume / barMaxValue) * 100);
            soundLevelBar.style.width = soundPercentage + '%';
            
            let hue = 120 - (soundPercentage * 1.2); 
            soundLevelBar.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;

            if (!isPlaying) {
                const scale = 1 + (averageVolume / 255) * 0.5;
                visualizer.style.transform = `scale(${scale})`;
            }

            const currentTime = Date.now() / 1000;

            if (averageVolume > SOUND_THRESHOLD) {
                // ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶∞‡¶ø‡¶Ç‡¶ü‡ßã‡¶® ‡¶¨‡¶æ‡¶ú‡¶¨‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶ï‡ßç‡¶∞‡¶∏ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá
                if (!isPlaying && (currentTime - lastPlayedTime > COOLDOWN_SECONDS) && alertCount < MAX_ALERTS) {
                    
                    isPlaying = true;
                    lastPlayedTime = currentTime;
                    
                    // ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡ßã
                    alertCount++;
                    updateCountDisplay(); // ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü

                    statusDiv.textContent = `ALERT! (Level: ${averageVolume.toFixed(2)}) - Playing alert!`;
                    ringtone.play();
                    visualizer.classList.add('alert');
                    visualizer.textContent = 'üö®';
                }
            }
            requestAnimationFrame(checkSoundLevel);
        }

        // ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function updateCountDisplay() {
            countDisplay.textContent = `Alerts: ${alertCount} / ${MAX_ALERTS}`;
            if (alertCount >= MAX_ALERTS) {
                countDisplay.classList.add('limit-reached');
                visualizer.textContent = 'üö´'; // ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶á‡¶ï‡¶®
            } else {
                countDisplay.classList.remove('limit-reached');
            }
        }

        ringtone.onended = () => {
            isPlaying = false;
            visualizer.classList.remove('alert');
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶™ ‡¶Ü‡¶á‡¶ï‡¶®, ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶π‡ßá‡¶°‡¶´‡ßã‡¶®
            if (alertCount >= MAX_ALERTS) {
                visualizer.textContent = 'üö´';
            } else {
                visualizer.textContent = 'üéß';
            }
        };

        async function startMonitoring() {
            try {
                const fileName = fileNameSelect.value; 
                SOUND_THRESHOLD = parseFloat(thresholdInput.value);
                const intervalSeconds = parseFloat(intervalInput.value);
                LOG_INTERVAL_MS = intervalSeconds * 1000; 
                
                // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                MAX_ALERTS = parseInt(maxAlertsInput.value);
                
                barMaxValue = SOUND_THRESHOLD * 1.10; 
                
                // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞
                alertCount = 0;
                updateCountDisplay();
                
                ringtone.src = './' + fileName; 
                ringtone.load(); 

                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; 
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                settingsContainer.disabled = true; 
                toggleButton.textContent = "Stop & Reset"; // ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ö‡ßá‡¶û‡ßç‡¶ú
                toggleButton.classList.add('stop-mode');
                statusDiv.textContent = "Monitoring sound level...";
                statusDiv.style.color = "var(--light-text)";
                
                isListening = true; 
                checkSoundLevel();

                logInterval = setInterval(() => {
                    const newLogItem = document.createElement('li');
                    const timestamp = new Date().toLocaleTimeString();
                    newLogItem.textContent = `[${timestamp}] Level: ${averageVolume.toFixed(2)}`;
                    logList.prepend(newLogItem);
                    if (logList.children.length > 50) {
                        logList.removeChild(logList.lastChild);
                    }
                }, LOG_INTERVAL_MS); 

            } catch (err) {
                console.error("Error starting monitoring:", err);
                statusDiv.textContent = `Error: ${err.message}.`;
                stopMonitoring(); 
            }
        }
        
        function stopMonitoring() {
            isListening = false; 
            if (wakeLock) {
                wakeLock.release().then(() => { wakeLock = null; });
            }
            if (audioContext) audioContext.close();
            if (stream) stream.getTracks().forEach(track => track.stop());
            if (logInterval) clearInterval(logInterval);
            
            settingsContainer.disabled = false; 
            toggleButton.textContent = "Start Listening";
            toggleButton.classList.remove('stop-mode');
            
            statusDiv.textContent = "Click 'Start Listening' to begin.";
            statusDiv.style.color = "var(--light-text)";
            
            visualizer.textContent = 'üéß';
            visualizer.classList.remove('alert');
            visualizer.style.transform = 'scale(1)';
            soundLevelBar.style.width = '0%';
            soundLevelBar.style.backgroundColor = 'hsl(120, 100%, 50%)'; 
            
            // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá (UI-‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø, ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ‡¶™‡¶∞‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá)
            countDisplay.classList.remove('limit-reached');
            
            ringtone.pause();
            ringtone.currentTime = 0;
            isPlaying = false;
        }

        toggleButton.onclick = () => {
            if (isListening) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        };
    </script>

</body>
</html>
